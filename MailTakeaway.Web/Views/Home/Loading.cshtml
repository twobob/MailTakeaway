@{
    ViewData["Title"] = "Loading...";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 text-center">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h3 class="mt-4">Processing Email Archive...</h3>
            <p class="text-muted" id="statusMessage">
                Please wait while we index the email archive. This may take a few minutes.
            </p>
            
            <div class="card mt-4" id="progressCard" style="display: none;">
                <div class="card-body">
                    <div class="row text-start">
                        <div class="col-md-6">
                            <p><strong>Messages Found:</strong> <span id="totalMessages" class="text-primary">0</span></p>
                            <p><strong>Successfully Parsed:</strong> <span id="successfullyParsed" class="text-success">0</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Duplicates:</strong> <span id="duplicates" class="text-warning">0</span></p>
                            <p><strong>Parse Errors:</strong> <span id="parseErrors" class="text-danger">0</span></p>
                        </div>
                    </div>
                    
                    <div id="errorMessages" class="mt-3" style="display: none;">
                        <hr>
                        <h6 class="text-danger"><i class="bi bi-exclamation-triangle"></i> Parse Errors:</h6>
                        <div class="alert alert-danger text-start" style="max-height: 200px; overflow-y: auto;">
                            <ul id="errorList" class="mb-0" style="font-size: 0.9em;"></ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info mt-4">
                <i class="bi bi-info-circle"></i> <span id="autoRefreshMessage">Checking progress...</span>
            </div>
        </div>
    </div>
</div>

<script>
    let checkCount = 0;
    
    function updateProgress() {
        checkCount++;
        
        fetch('@Url.Action("Progress", "Home")')
            .then(response => response.json())
            .then(data => {
                console.log('Progress data:', data);
                
                // If initialized, redirect to home (case-insensitive check)
                if (data.isInitialized || data.IsInitialized) {
                    document.getElementById('statusMessage').textContent = 'Ready! Redirecting...';
                    window.location.href = '@Url.Action("Index", "Home")';
                    return;
                }
                
                // If actively indexing, show progress
                const totalMessages = data.totalMessages || data.TotalMessages || 0;
                const isIndexing = data.isIndexing || data.IsIndexing || false;
                
                if (isIndexing) {
                    const progressCard = document.getElementById('progressCard');
                    progressCard.style.display = 'block';
                    
                    document.getElementById('totalMessages').textContent = totalMessages;
                    document.getElementById('successfullyParsed').textContent = data.successfullyParsed || data.SuccessfullyParsed || 0;
                    document.getElementById('duplicates').textContent = data.duplicates || data.Duplicates || 0;
                    document.getElementById('parseErrors').textContent = data.parseErrors || data.ParseErrors || 0;
                    
                    const errorMessages = data.parseErrorMessages || data.ParseErrorMessages || [];
                    if (errorMessages.length > 0) {
                        const errorDiv = document.getElementById('errorMessages');
                        const errorList = document.getElementById('errorList');
                        errorDiv.style.display = 'block';
                        errorList.innerHTML = errorMessages.map(msg => `<li>${msg}</li>`).join('');
                    }
                    
                    document.getElementById('autoRefreshMessage').textContent = 
                        `Indexing in progress... (${checkCount} checks)`;
                } else {
                    // Waiting to start or loading from cache
                    document.getElementById('autoRefreshMessage').textContent = 
                        `Initializing... (${checkCount} checks)`;
                }
                
                // Continue checking
                setTimeout(updateProgress, 1000);
            })
            .catch(err => {
                console.error('Progress check failed:', err);
                document.getElementById('autoRefreshMessage').textContent = 
                    `Connection error, retrying... (${checkCount})`;
                setTimeout(updateProgress, 2000);
            });
    }
    
    // Start checking progress immediately
    updateProgress();
</script>
